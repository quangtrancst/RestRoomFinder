<!DOCTYPE html>
<html>
  <head>
    <title>Nearest Restrooms</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
      #map {
        height: 600px;
      }
      #searchButton {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Nearest Restrooms</h1>
    <div id="map"></div>
    <button id="searchButton">Tìm kiếm</button>

    <script>
      // Tạo bản đồ và đặt vị trí trung tâm là tọa độ của người dùng
      const userLocation = [10.775, 106.7];
      const map = L.map("map").setView(userLocation, 15);

      // Sử dụng tile miễn phí của OpenStreetMap
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Thêm marker cho vị trí người dùng
      let userMarker = L.marker(userLocation, { color: "red" })
        .addTo(map)
        .bindPopup("<b>Your Location</b>")
        .openPopup();

      // Mảng lưu trữ các marker nhà vệ sinh
      let restroomMarkers = [];

      // Cập nhật vị trí người dùng khi nhấp vào bản đồ
      map.on("click", function (e) {
        if (userMarker) {
          map.removeLayer(userMarker);
        }
        userMarker = L.marker(e.latlng, { color: "red" })
          .addTo(map)
          .bindPopup("<b>Your Location</b>")
          .openPopup();
        userLocation[0] = e.latlng.lat;
        userLocation[1] = e.latlng.lng;
      });

      // Xử lý sự kiện khi nhấn nút tìm kiếm
      document
        .getElementById("searchButton")
        .addEventListener("click", function () {
          // Xóa các marker cũ
          restroomMarkers.forEach((marker) => map.removeLayer(marker));
          restroomMarkers = [];

          // Gửi yêu cầu đến API để tìm nhà vệ sinh gần nhất
          fetch(
            `http://localhost:5000/find_nearby_restrooms?lat=${userLocation[0]}&lon=${userLocation[1]}&radius=1.0`
          )
            .then((response) => response.json())
            .then((data) => {
              console.log(data); // Log dữ liệu trả về từ API
              data.forEach((restroom) => {
                const marker = L.marker([
                  restroom.coordinates[0],
                  restroom.coordinates[1],
                ])
                  .addTo(map)
                  .bindPopup(
                    `<b>${restroom.address}</b><br>${
                      restroom.description
                    }<br>Distance: ${restroom.distance_km.toFixed(2)} km`
                  );
                restroomMarkers.push(marker);
              });
            })
            .catch((error) => console.error("Error:", error));
        });
    </script>
  </body>
</html>
